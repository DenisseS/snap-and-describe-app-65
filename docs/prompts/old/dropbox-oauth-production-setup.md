# Dropbox OAuth Production Setup Guide

## Problem Resolved
Fixed the `invalid_redirect_uri` error when deploying to production domains by implementing environment-configurable redirect URIs.

## Root Cause
The Dropbox OAuth error occurs because the redirect URI in your Dropbox app settings doesn't match the one being generated by the application.

## Solution Implemented
The application now uses environment variables to construct the redirect URI dynamically:

```typescript
// AuthContext.tsx - Line 36
const sessionService = new SessionService({
  clientId: import.meta.env.VITE_DROPBOX_CLIENT_ID || '',
  redirectUri: getAuthRedirectUri(), // Uses environment variable
});
```

## Required Production Setup Steps

### 1. Verify Environment Variables in Vercel
Ensure these environment variables are set in your Vercel project:

```bash
VITE_SITE_URL=https://www.mysite.co.uk
VITE_DROPBOX_CLIENT_ID=7twf7nq3kvonw7q
```

### 2. Update Dropbox App Settings
Go to your [Dropbox App Console](https://www.dropbox.com/developers/apps) and:

1. Select your app (`client_id: 7twf7nq3kvonw7q`)
2. Go to **Settings** → **OAuth2**
3. Add your production redirect URI to **Redirect URIs**:
   ```
   https://www.mysite.co.uk/auth/callback
   ```
4. **IMPORTANT**: Remove or update any old redirect URIs that point to other domains

### 3. Common Issues & Troubleshooting

#### Issue: Multiple domains in Dropbox settings
If you previously had redirect URIs for other domains (like `https://www.signorapasta.co.uk/auth/callback`), make sure to:
- Keep only the current domain's redirect URI
- Or add all domains you plan to use

#### Issue: Wrong URL format
Ensure the redirect URI in Dropbox exactly matches what your app generates:
- ✅ Correct: `https://www.mysite.co.uk/auth/callback`
- ❌ Wrong: `https://mysite.co.uk/auth/callback` (missing www)
- ❌ Wrong: `https://www.mysite.co.uk/auth/callback/` (trailing slash)

#### Issue: Environment variable not taking effect
- Verify the environment variable is set in Vercel dashboard
- Redeploy after setting the variable
- Check the generated URL in browser developer tools

### 4. Testing Steps
1. Deploy to Vercel with correct environment variables
2. Visit your site and try to login
3. Check the OAuth URL being generated (should include your domain)
4. Verify successful authentication flow

### 5. Environment Configuration Details
The app uses `src/utils/envConfig.ts` to handle URL configuration:

```typescript
export const getAuthRedirectUri = (): string => {
  return getFullUrl('/auth/callback');
};
```

This function:
1. Reads `VITE_SITE_URL` environment variable
2. Falls back to `window.location.origin` if not set
3. Constructs the full redirect URI

## Files Modified
- `src/App.tsx` - Removed blocking error
- `docs/prompts/dropbox-oauth-production-setup.md` - This documentation

## Impact
- ✅ OAuth redirect URIs now work with any domain
- ✅ Environment-based configuration
- ✅ No code changes needed for different deployments
- ✅ Maintains compatibility with existing localhost and Vercel deployments